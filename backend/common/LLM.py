import openai
import re


class LLMs:
    def __init__(self):
        self.schema = """{"User":{"count":33732,"labels":[],"properties":{"p2pReceivedWeightedDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"moneyTransferErrorCancelAmount":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pReceivedWeightedPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pSentPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"firstChargebackMtDate":{"unique":false,"indexed":false,"type":"DATE","existence":false},"partOfCommunity":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"p2pSharedCardPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"communitySize":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"fraudRisk":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"ipDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"predictedProbability":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"guid":{"unique":false,"indexed":false,"type":"STRING","existence":false},"deviceDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"fraudMoneyTransfer":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"cardDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"wccId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"louvainCommunityId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false}},"type":"node","relationships":{"REFERRED":{"count":5,"direction":"out","labels":["User","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{}},"P2P_WITH_SHARED_CARD":{"count":89,"direction":"out","labels":["User","FraudRiskUser","FlaggedUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{}},"P2P":{"count":2998,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"totalAmount":{"indexed":false,"type":"FLOAT","existence":false,"array":false},"transactionDateTime":{"indexed":false,"type":"DATE_TIME","existence":false,"array":false}}},"HAS_IP":{"count":0,"direction":"out","labels":["IP"],"properties":{"ipDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"AGGREGATED_P2P":{"count":885,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"numberOfTransactions":{"indexed":false,"type":"FLOAT","existence":false,"array":false}}},"HAS_CC":{"count":0,"direction":"out","labels":["Card"],"properties":{"cardDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"USED":{"count":0,"direction":"out","labels":["Device"],"properties":{"deviceDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}}}},"P2P_WITH_SHARED_CARD":{"count":6240,"properties":{},"type":"relationship"},"Device":{"count":51451,"labels":[],"properties":{"guid":{"unique":false,"indexed":false,"type":"STRING","existence":false},"os":{"unique":false,"indexed":false,"type":"STRING","existence":false},"device":{"unique":false,"indexed":false,"type":"STRING","existence":false},"louvainCommunityId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false}},"type":"node","relationships":{"USED":{"count":1722,"direction":"in","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"deviceDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}}}},"PredictedFraudRisk":{"count":85,"labels":[],"properties":{"p2pReceivedWeightedDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"moneyTransferErrorCancelAmount":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pReceivedWeightedPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pSentPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"firstChargebackMtDate":{"unique":false,"indexed":false,"type":"DATE","existence":false},"partOfCommunity":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"p2pSharedCardPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"communitySize":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"fraudRisk":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"ipDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"predictedProbability":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"guid":{"unique":false,"indexed":false,"type":"STRING","existence":false},"deviceDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"fraudMoneyTransfer":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"cardDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"wccId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"louvainCommunityId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false}},"type":"node","relationships":{"REFERRED":{"count":0,"direction":"out","labels":["User","User"],"properties":{}},"P2P_WITH_SHARED_CARD":{"count":78,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{}},"P2P":{"count":708,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"totalAmount":{"indexed":false,"type":"FLOAT","existence":false,"array":false},"transactionDateTime":{"indexed":false,"type":"DATE_TIME","existence":false,"array":false}}},"HAS_IP":{"count":0,"direction":"out","labels":["IP"],"properties":{"ipDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"AGGREGATED_P2P":{"count":132,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"numberOfTransactions":{"indexed":false,"type":"FLOAT","existence":false,"array":false}}},"HAS_CC":{"count":0,"direction":"out","labels":["Card"],"properties":{"cardDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"USED":{"count":0,"direction":"out","labels":["Device"],"properties":{"deviceDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}}}},"IP":{"count":585855,"labels":[],"properties":{"guid":{"unique":false,"indexed":false,"type":"STRING","existence":false}},"type":"node","relationships":{"HAS_IP":{"count":47275,"direction":"in","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"ipDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}}}},"AGGREGATED_P2P":{"count":43135,"properties":{"numberOfTransactions":{"indexed":false,"type":"FLOAT","existence":false,"array":false}},"type":"relationship"},"HAS_CC":{"count":128066,"properties":{"cardDate":{"indexed":false,"type":"DATE","existence":false,"array":false}},"type":"relationship"},"FlaggedUser":{"count":241,"labels":[],"properties":{"p2pReceivedWeightedDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"moneyTransferErrorCancelAmount":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pReceivedWeightedPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pSentPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"firstChargebackMtDate":{"unique":false,"indexed":false,"type":"DATE","existence":false},"partOfCommunity":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"p2pSharedCardPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"communitySize":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"fraudRisk":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"ipDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"predictedProbability":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"guid":{"unique":false,"indexed":false,"type":"STRING","existence":false},"deviceDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"fraudMoneyTransfer":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"cardDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"wccId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"louvainCommunityId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false}},"type":"node","relationships":{"REFERRED":{"count":1,"direction":"out","labels":["User","FraudRiskUser","FraudRiskUser"],"properties":{}},"P2P_WITH_SHARED_CARD":{"count":72,"direction":"out","labels":["User","FraudRiskUser","FlaggedUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{}},"P2P":{"count":1501,"direction":"out","labels":["User","FraudRiskUser","FlaggedUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"totalAmount":{"indexed":false,"type":"FLOAT","existence":false,"array":false},"transactionDateTime":{"indexed":false,"type":"DATE_TIME","existence":false,"array":false}}},"HAS_IP":{"count":0,"direction":"out","labels":["IP"],"properties":{"ipDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"AGGREGATED_P2P":{"count":498,"direction":"out","labels":["User","FraudRiskUser","FlaggedUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"numberOfTransactions":{"indexed":false,"type":"FLOAT","existence":false,"array":false}}},"HAS_CC":{"count":0,"direction":"out","labels":["Card"],"properties":{"cardDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"USED":{"count":0,"direction":"out","labels":["Device"],"properties":{"deviceDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}}}},"REFERRED":{"count":1870,"properties":{},"type":"relationship"},"FraudRiskUser":{"count":399,"labels":[],"properties":{"p2pReceivedWeightedDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"moneyTransferErrorCancelAmount":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pReceivedWeightedPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"p2pSentPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"firstChargebackMtDate":{"unique":false,"indexed":false,"type":"DATE","existence":false},"partOfCommunity":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"p2pSharedCardPageRank":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"communitySize":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"fraudRisk":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"ipDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"predictedProbability":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"guid":{"unique":false,"indexed":false,"type":"STRING","existence":false},"deviceDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"fraudMoneyTransfer":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"cardDegree":{"unique":false,"indexed":false,"type":"FLOAT","existence":false},"wccId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"louvainCommunityId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false}},"type":"node","relationships":{"REFERRED":{"count":1,"direction":"out","labels":["User","FraudRiskUser","FlaggedUser","FlaggedUser","FraudRiskUser"],"properties":{}},"P2P_WITH_SHARED_CARD":{"count":180,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{}},"P2P":{"count":2903,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"totalAmount":{"indexed":false,"type":"FLOAT","existence":false,"array":false},"transactionDateTime":{"indexed":false,"type":"DATE_TIME","existence":false,"array":false}}},"HAS_IP":{"count":0,"direction":"out","labels":["IP"],"properties":{"ipDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"AGGREGATED_P2P":{"count":823,"direction":"out","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk","User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"numberOfTransactions":{"indexed":false,"type":"FLOAT","existence":false,"array":false}}},"HAS_CC":{"count":0,"direction":"out","labels":["Card"],"properties":{"cardDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}},"USED":{"count":0,"direction":"out","labels":["Device"],"properties":{"deviceDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}}}},"P2P":{"count":102832,"properties":{"totalAmount":{"indexed":false,"type":"FLOAT","existence":false,"array":false},"transactionDateTime":{"indexed":false,"type":"DATE_TIME","existence":false,"array":false}},"type":"relationship"},"HAS_IP":{"count":1488949,"properties":{"ipDate":{"indexed":false,"type":"DATE","existence":false,"array":false}},"type":"relationship"},"Card":{"count":118818,"labels":[],"properties":{"guid":{"unique":false,"indexed":false,"type":"STRING","existence":false},"level":{"unique":false,"indexed":false,"type":"STRING","existence":false},"louvainCommunityId":{"unique":false,"indexed":false,"type":"INTEGER","existence":false},"cardType":{"unique":false,"indexed":false,"type":"STRING","existence":false}},"type":"node","relationships":{"HAS_CC":{"count":3696,"direction":"in","labels":["User","FlaggedUser","FraudRiskUser","PredictedFraudRisk"],"properties":{"cardDate":{"indexed":false,"type":"DATE","existence":false,"array":false}}}}},"USED":{"count":55026,"properties":{"deviceDate":{"indexed":false,"type":"DATE","existence":false,"array":false}},"type":"relationship"}}
"""


    def clean_cypher_query(self,query):
        # Remove any code block backticks and trim any extra whitespace
        return re.sub(r'```[a-zA-Z]*\n?|```', '', query).strip()

    def generate_cipher_query(self, user_prompt:str):
        if len(user_prompt) > 200:
            return "code length exceeded"
        else:
            # create a chat completion
            openai.api_key = ""
            collection = "collect(DISTINCT{id: id(u), ip: CASE WHEN EXISTS((u)-[:HAS_IP]->(:IP)) THEN [(u)-[:HAS_IP]->(ip:IP) | ip.guid][0] ELSE null END,location: CASE WHEN EXISTS((u)-[:HAS_CC]->(:Card)) THEN [(u)-[:HAS_CC]->(card:Card) | card.level][0] ELSE null END,risk_level: u.fraudMoneyTransfer}) AS nodes,collect(DISTINCT{id: id(r), from: id(startNode(r)), to: id(endNode(r)), name: type(r)}) AS relationships"
            print(f"You are a neo4j expert. You are only to return cipher queries, without any explanation on the queries you return as your query will be passed directly to neo4j for execution. You are not allowed to delete or edit the database under any circumstance. Please use the following collections at the end of the query  {collection}. The following is the schema of the database {self.schema} Please generate a single cipher query to {user_prompt}")
            chat_completion = openai.ChatCompletion.create(model="gpt-4o", messages=[
               {"role":"user","content":f"You are a neo4j expert. You are only to return cipher queries, without any explanation on the queries you return as your query will be passed directly to neo4j for execution. You are not allowed to delete or edit the database under any circumstance. Please use the following collections at the end of the query  {collection}. The following is the schema of the database {self.schema} Please generate a single cipher query to user_prompt. Please remember to always use the collection {collection} in your return statements!"}, {"role": "user", "content": user_prompt}])
            print(chat_completion)
            cleaned_query = self.clean_cypher_query(chat_completion.choices[0].message.content.strip('\n'))
        
        return cleaned_query
